version: '3.8'

services:
  # Test-specific PostgreSQL with pgvector
  test-postgres:
    image: ankane/pgvector:latest
    environment:
      POSTGRES_DB: test_resolve_db
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test123
    ports:
      - "0:5432"  # Random port to avoid conflicts
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d test_resolve_db"]
      interval: 5s
      timeout: 3s
      retries: 10
    tmpfs:
      - /var/lib/postgresql/data  # Use memory for speed

  # Test app container
  test-app:
    build:
      context: ..
      dockerfile: tests/Dockerfile.test
    depends_on:
      test-postgres:
        condition: service_healthy
    environment:
      # Database config for test
      POSTGRES_HOST: test-postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: test_resolve_db
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test123
      # App config
      NODE_ENV: test
      PORT: 5000
      SESSION_SECRET: test-secret-key
      JWT_SECRET: test-jwt-secret
      # Disable rate limiting in tests
      DISABLE_RATE_LIMIT: "true"
      # Test admin credentials
      ADMIN_EMAIL: admin@test.com
      ADMIN_PASSWORD: admin123
    ports:
      - "0:5000"  # Random port to avoid conflicts
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 5s
      timeout: 3s
      retries: 10
    volumes:
      # Mount test files but NOT node_modules
      - ../tests:/app/tests:ro
      - /app/node_modules  # Use container's node_modules