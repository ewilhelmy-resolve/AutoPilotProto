<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resolve Admin Dashboard - Workflow Triggers</title>
    <link rel="stylesheet" href="/styles/fonts.css">
    <link rel="stylesheet" href="/styles/typography.css">
    <link rel="stylesheet" href="/styles/base.css">
    <link rel="stylesheet" href="/styles/table.css">
    <link rel="stylesheet" href="/styles/admin-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <div class="header-content">
                <h1>Resolve.io Admin Dashboard</h1>
                <div class="user-info">
                    <span id="adminEmail"></span>
                    <button id="logoutBtn" class="btn-logout">Logout</button>
                </div>
            </div>
        </header>

        <nav class="admin-nav">
            <ul>
                <li><a href="#overview" class="nav-link active">Overview</a></li>
                <li><a href="#tenant-management" class="nav-link">Tenant Management</a></li>
                <li><a href="#triggers" class="nav-link">Workflow Triggers</a></li>
                <li><a href="#users" class="nav-link">User Activity</a></li>
                <li><a href="#analytics" class="nav-link">Analytics</a></li>
                <li><a href="#logs" class="nav-link">System Logs</a></li>
                <li><a href="#webhooks" class="nav-link">Webhook Logs</a></li>
                <li><a href="#webhook-traffic" class="nav-link">Callback Traffic</a></li>
                <li><a href="#settings" class="nav-link">System Settings</a></li>
            </ul>
        </nav>

        <main class="admin-main">
            <!-- Overview Section -->
            <section id="overview" class="admin-section active">
                <h2>Workflow Trigger Overview</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalTriggers">0</div>
                        <div class="stat-label">Total Triggers</div>
                        <div class="stat-change" id="triggersChange">+0%</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="uniqueUsers">0</div>
                        <div class="stat-label">Active Users</div>
                        <div class="stat-change" id="usersChange">+0%</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="successRate">0%</div>
                        <div class="stat-label">Success Rate</div>
                        <div class="stat-change" id="successChange">+0%</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="todayTriggers">0</div>
                        <div class="stat-label">Today's Triggers</div>
                        <div class="stat-change" id="todayChange">+0%</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Daily Trigger Trends</h3>
                        <canvas id="trendsChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Triggers by Type</h3>
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 16px;">Most Active Users</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="table-th">User Email</th>
                                <th class="table-th">Total Triggers</th>
                                <th class="table-th">Success Rate</th>
                                <th class="table-th">Last Activity</th>
                            </tr>
                        </thead>
                        <tbody id="topUsersTable">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Tenant Management Section -->
            <section id="tenant-management" class="admin-section">
                <h2>Tenant Management</h2>
                
                <div class="user-controls">
                    <div class="search-bar">
                        <input type="text" id="userSearchInput" placeholder="Search by email or company...">
                        <button id="searchUsersBtn" class="btn-primary">Search</button>
                        <button id="clearSearchBtn" class="btn-secondary">Clear</button>
                    </div>
                    
                    <div class="filter-controls">
                        <select id="tierFilter">
                            <option value="">All Tiers</option>
                            <option value="standard">Standard</option>
                            <option value="premium">Premium</option>
                            <option value="enterprise">Enterprise</option>
                        </select>
                        
                        <select id="sortBy">
                            <option value="created_at">Registration Date</option>
                            <option value="email">Email</option>
                            <option value="company_name">Company</option>
                            <option value="tier">Tier</option>
                            <option value="updated_at">Last Updated</option>
                        </select>
                        
                        <select id="sortOrder">
                            <option value="desc">Newest First</option>
                            <option value="asc">Oldest First</option>
                        </select>
                        
                        <button id="refreshUsersBtn" class="btn-refresh">Refresh</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table" id="usersManagementTable">
                        <thead>
                            <tr>
                                <th class="table-th">Email</th>
                                <th class="table-th">Company</th>
                                <th class="table-th">Phone</th>
                                <th class="table-th">Tier</th>
                                <th class="table-th">Tickets</th>
                                <th class="table-th">Registered</th>
                                <th class="table-th">Last Login</th>
                                <th class="table-th table-th-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Edit User Modal -->
                <div id="editUserModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit User</h3>
                            <span class="close-modal">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="editUserForm">
                                <div class="form-group">
                                    <label>Email:</label>
                                    <input type="email" id="editUserEmail" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Company Name:</label>
                                    <input type="text" id="editCompanyName">
                                </div>
                                <div class="form-group">
                                    <label>Phone:</label>
                                    <input type="tel" id="editPhone">
                                </div>
                                <div class="form-group">
                                    <label>Tier:</label>
                                    <select id="editTier">
                                        <option value="standard">Standard</option>
                                        <option value="premium">Premium</option>
                                        <option value="enterprise">Enterprise</option>
                                    </select>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn-primary">Save Changes</button>
                                    <button type="button" class="btn-secondary" id="cancelEdit">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Workflow Triggers Section -->
            <section id="triggers" class="admin-section">
                <h2>Recent Workflow Triggers</h2>
                
                <div class="filters">
                    <select id="triggerTypeFilter">
                        <option value="">All Types</option>
                        <option value="onboarding">Onboarding</option>
                        <option value="integration">Integration</option>
                        <option value="csv_upload">CSV Upload</option>
                        <option value="validation">Validation</option>
                    </select>
                    
                    <select id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="true">Successful</option>
                        <option value="false">Failed</option>
                    </select>
                    
                    <input type="date" id="dateFilter" />
                    
                    <button id="refreshTriggers" class="btn-refresh">Refresh</button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="table-th">Timestamp</th>
                                <th class="table-th">User</th>
                                <th class="table-th">Type</th>
                                <th class="table-th">Action</th>
                                <th class="table-th">Status</th>
                                <th class="table-th">Response</th>
                                <th class="table-th">Details</th>
                            </tr>
                        </thead>
                        <tbody id="triggersTable">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- User Activity Section -->
            <section id="users" class="admin-section">
                <h2>User Activity Details</h2>
                
                <div class="user-search">
                    <input type="email" id="userEmailSearch" placeholder="Enter user email..." />
                    <button id="searchUser" class="btn-search">Search</button>
                </div>

                <div id="userActivityContent">
                    <!-- Dynamic user activity content -->
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="admin-section">
                <h2>Detailed Analytics</h2>
                
                <div class="analytics-controls">
                    <select id="dateRange">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                </div>

                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>Triggers by Action</h3>
                        <canvas id="actionChart"></canvas>
                    </div>
                    
                    <div class="analytics-card">
                        <h3>Success vs Failure Trends</h3>
                        <canvas id="successFailChart"></canvas>
                    </div>
                    
                    <div class="analytics-card">
                        <h3>Hourly Distribution</h3>
                        <canvas id="hourlyChart"></canvas>
                    </div>
                    
                    <div class="analytics-card">
                        <h3>Weekly Pattern</h3>
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- System Logs Section -->
            <section id="logs" class="admin-section">
                <h2>System Logs & Diagnostics</h2>
                
                <div class="logs-container">
                    <!-- Environment Status -->
                    <div class="diagnostics-card">
                        <h3>Environment Variables Status</h3>
                        <div id="envStatus" class="env-status-grid">
                            <div class="status-loading">Checking environment...</div>
                        </div>
                    </div>

                    <!-- Database Connection Status -->
                    <div class="diagnostics-card">
                        <h3>Database Connection</h3>
                        <div id="dbStatus" class="db-status">
                            <div class="status-loading">Testing connection...</div>
                        </div>
                    </div>

                    <!-- Recent Errors -->
                    <div class="diagnostics-card full-width">
                        <h3>Recent Application Errors</h3>
                        <div class="logs-controls">
                            <button onclick="refreshLogs()" class="btn btn-secondary">Refresh Logs</button>
                            <button onclick="clearLogs()" class="btn btn-danger">Clear Logs</button>
                            <select id="logLevel" onchange="filterLogs(this.value)">
                                <option value="all">All Levels</option>
                                <option value="error">Errors Only</option>
                                <option value="warn">Warnings</option>
                                <option value="info">Info</option>
                            </select>
                        </div>
                        <div id="errorLogs" class="error-logs">
                            <div class="status-loading">Loading logs...</div>
                        </div>
                    </div>

                    <!-- RAG System Status -->
                    <div class="diagnostics-card">
                        <h3>RAG System Status</h3>
                        <div id="ragStatus" class="rag-status">
                            <div class="status-loading">Checking RAG system...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Webhook Logs Section -->
            <section id="webhooks" class="admin-section">
                <h2>Webhook Call Logs</h2>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="table-th">Timestamp</th>
                                <th class="table-th">User</th>
                                <th class="table-th">Upload File</th>
                                <th class="table-th">Status</th>
                                <th class="table-th">Response</th>
                                <th class="table-th">Error</th>
                            </tr>
                        </thead>
                        <tbody id="webhooksTable">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Webhook Traffic Logs Section -->
            <section id="webhook-traffic" class="admin-section">
                <h2>Callback & Webhook Traffic Monitor</h2>
                
                <div class="traffic-controls">
                    <div class="filter-row">
                        <select id="trafficCategoryFilter">
                            <option value="all">All Callbacks</option>
                            <option value="chat_callback">Chat Callbacks</option>
                            <option value="test_callback">Test Callbacks</option>
                            <option value="callback">Other Callbacks</option>
                            <option value="webhook">Webhooks</option>
                        </select>
                        
                        <select id="trafficMethodFilter">
                            <option value="all">All Methods</option>
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                        
                        <select id="trafficStatusFilter">
                            <option value="">All Status</option>
                            <option value="200">200 OK</option>
                            <option value="201">201 Created</option>
                            <option value="400">400 Bad Request</option>
                            <option value="401">401 Unauthorized</option>
                            <option value="404">404 Not Found</option>
                            <option value="500">500 Server Error</option>
                        </select>
                        
                        <label>
                            <input type="checkbox" id="webhooksOnlyFilter"> Failed Only
                        </label>
                    </div>
                    
                    <div class="search-row">
                        <input type="text" id="trafficSearchInput" placeholder="Search in URL, body, or response...">
                        <button id="searchTrafficBtn" class="btn-primary">Search</button>
                        <button id="refreshTrafficBtn" class="btn-refresh">Refresh</button>
                        <button id="clearOldTrafficBtn" class="btn-danger">Clear Old Logs</button>
                    </div>
                </div>
                
                <div class="traffic-stats">
                    <span id="totalTrafficCount">Total: 0</span>
                    <span id="webhookTrafficCount">Webhooks: 0</span>
                    <span id="failedTrafficCount">Failed: 0</span>
                </div>
                
                <div class="table-container">
                    <table class="data-table" id="trafficTable">
                        <thead>
                            <tr>
                                <th class="table-th">Time</th>
                                <th class="table-th">Method</th>
                                <th class="table-th">URL</th>
                                <th class="table-th">Category</th>
                                <th class="table-th">Status</th>
                                <th class="table-th">IP</th>
                                <th class="table-th table-th-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trafficTableBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination">
                    <button id="trafficPrevPage" class="btn-secondary">Previous</button>
                    <span id="trafficPageInfo">Page 1</span>
                    <button id="trafficNextPage" class="btn-secondary">Next</button>
                </div>
            </section>

            <!-- System Settings Section -->
            <section id="settings" class="admin-section">
                <h2>System Settings</h2>
                
                <div class="settings-container">
                    <div class="settings-card">
                        <h3>Application Configuration</h3>
                        <form id="settingsForm">
                            <div class="form-group">
                                <label for="appUrl">Callback Base URL</label>
                                <input type="url" id="appUrl" name="app_url" 
                                       placeholder="http://your-server-ip:5000"
                                       title="Base URL for webhook callbacks (e.g., http://192.168.1.100:5000 or https://your-domain.com)">
                                <small>This URL will be used for webhook callbacks from external services. Use your server's IP or domain, not localhost.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="webhookEnabled">Webhook Functionality</label>
                                <select id="webhookEnabled" name="webhook_enabled">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                                <small>Enable or disable webhook functionality globally</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="maxDocSize">Max Document Size (bytes)</label>
                                <input type="number" id="maxDocSize" name="max_document_size" 
                                       min="1024" max="10485760" step="1024">
                                <small>Maximum size for RAG documents (default: 51200 = 50KB)</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="vectorDim">Vector Dimension</label>
                                <input type="number" id="vectorDim" name="vector_dimension" 
                                       min="1" max="4096" readonly>
                                <small>Embedding vector dimension (OpenAI: 1536)</small>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn-primary">Save Settings</button>
                                <button type="button" class="btn-secondary" id="resetSettings">Reset to Defaults</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="settings-card">
                        <h3>Connection Test</h3>
                        <div class="test-container">
                            <p>Test if the callback URL is accessible from external services:</p>
                            <button id="testCallbackUrl" class="btn-test">Test Callback URL</button>
                            <div id="testResult" class="test-result"></div>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <h3>üîç Vector Database Status (pgvector)</h3>
                        <div class="pgvector-status">
                            <p>Check if pgvector extension is properly installed for RAG/vector search functionality:</p>
                            <button id="checkPgvector" class="btn-test">Check pgvector Status</button>
                            <div id="pgvectorResult" class="test-result" style="margin-top: 15px;"></div>
                            
                            <div id="pgvectorDetails" style="display: none; margin-top: 20px;">
                                <h4>Diagnostics Details:</h4>
                                <div class="diagnostics-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                                    <div class="diagnostic-item">
                                        <strong>Extension Installed:</strong>
                                        <span id="pgvectorInstalled" class="status-badge">Checking...</span>
                                    </div>
                                    <div class="diagnostic-item">
                                        <strong>Version:</strong>
                                        <span id="pgvectorVersion">-</span>
                                    </div>
                                    <div class="diagnostic-item">
                                        <strong>Vector Type Available:</strong>
                                        <span id="vectorTypeExists" class="status-badge">Checking...</span>
                                    </div>
                                    <div class="diagnostic-item">
                                        <strong>Operations Working:</strong>
                                        <span id="vectorOperations" class="status-badge">Checking...</span>
                                    </div>
                                    <div class="diagnostic-item">
                                        <strong>Total Vectors:</strong>
                                        <span id="totalVectorCount">-</span>
                                    </div>
                                    <div class="diagnostic-item">
                                        <strong>Active Tenants:</strong>
                                        <span id="activeTenantCount">-</span>
                                    </div>
                                </div>
                                
                                <div id="pgvectorErrors" style="display: none; margin-top: 15px; padding: 15px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px;">
                                    <h4 style="color: #dc2626; margin-top: 0;">‚ö†Ô∏è Issues Detected:</h4>
                                    <ul id="pgvectorErrorsList" style="margin: 10px 0; padding-left: 20px;"></ul>
                                    <div id="pgvectorFixInstructions" style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px;">
                                        <strong>To fix:</strong>
                                        <code style="display: block; margin-top: 5px; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                                            CREATE EXTENSION IF NOT EXISTS vector;
                                        </code>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px;">
                                    <button id="fixPgvector" class="btn-warning" style="display: none;">
                                        üîß Attempt Auto-Fix
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- SSE Test Section -->
            <section class="admin-section" style="margin-top: 30px;">
                <h2>üß™ SSE Stream Test</h2>
                <p>Test the Server-Sent Events stream by sending messages directly to an active chat session.</p>
                
                <div class="test-sse-container" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <div class="form-group">
                        <label for="testConversationId">Conversation ID:</label>
                        <input type="text" id="testConversationId" placeholder="Enter conversation ID from active chat" 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #666;">Get this from the browser console when a chat is active</small>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="testMessage">Test Message:</label>
                        <textarea id="testMessage" rows="3" 
                                  placeholder="Enter test message to send via SSE"
                                  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">Hello! This is a test message sent directly to the SSE stream. The boomerang is working! üéØ</textarea>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>
                            <input type="checkbox" id="storeInDb" checked>
                            Store message in database
                        </label>
                    </div>
                    
                    <button onclick="sendTestSSEMessage()" class="btn btn-primary" 
                            style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
                        üì° Send Test Message
                    </button>
                    
                    <div id="sseTestResult" style="margin-top: 15px; padding: 15px; border-radius: 4px; display: none;"></div>
                </div>
                
                <script>
                    async function sendTestSSEMessage() {
                        const conversationId = document.getElementById('testConversationId').value;
                        const message = document.getElementById('testMessage').value;
                        const storeInDb = document.getElementById('storeInDb').checked;
                        const resultDiv = document.getElementById('sseTestResult');
                        
                        if (!conversationId) {
                            resultDiv.style.display = 'block';
                            resultDiv.style.background = '#ffebee';
                            resultDiv.style.color = '#c62828';
                            resultDiv.innerHTML = '‚ùå Please enter a conversation ID';
                            return;
                        }
                        
                        if (!message) {
                            resultDiv.style.display = 'block';
                            resultDiv.style.background = '#ffebee';
                            resultDiv.style.color = '#c62828';
                            resultDiv.innerHTML = '‚ùå Please enter a test message';
                            return;
                        }
                        
                        try {
                            resultDiv.style.display = 'block';
                            resultDiv.style.background = '#fff3cd';
                            resultDiv.style.color = '#856404';
                            resultDiv.innerHTML = '‚è≥ Sending test message...';
                            
                            const response = await fetch('/api/rag/test-sse-message', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    conversation_id: conversationId,
                                    message: message,
                                    message_type: 'chat-response',
                                    store_in_db: storeInDb
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (response.ok && data.success) {
                                resultDiv.style.background = '#e8f5e9';
                                resultDiv.style.color = '#2e7d32';
                                resultDiv.innerHTML = `
                                    ‚úÖ <strong>Success!</strong><br>
                                    Message sent to ${data.clients_notified} SSE client(s)<br>
                                    Message ID: <code>${data.message_id}</code><br>
                                    <small>Check the chat UI to see if the message appeared</small>
                                `;
                            } else {
                                resultDiv.style.background = '#ffebee';
                                resultDiv.style.color = '#c62828';
                                resultDiv.innerHTML = `
                                    ‚ùå <strong>Error:</strong> ${data.error || 'Failed to send message'}<br>
                                    ${data.hint ? `<small>Hint: ${data.hint}</small>` : ''}
                                `;
                            }
                        } catch (error) {
                            resultDiv.style.display = 'block';
                            resultDiv.style.background = '#ffebee';
                            resultDiv.style.color = '#c62828';
                            resultDiv.innerHTML = `‚ùå <strong>Network Error:</strong> ${error.message}`;
                        }
                    }
                    
                    // Helper to get conversation ID from console
                    console.log('%cüìù To get conversation ID:', 'color: #4CAF50; font-weight: bold;');
                    console.log('%c1. Open the chat in another tab', 'color: #666;');
                    console.log('%c2. Send a message in the chat', 'color: #666;');
                    console.log('%c3. Look for "Conversation ID:" in the console', 'color: #666;');
                    console.log('%c4. Or run: localStorage.getItem("currentConversationId")', 'color: #666;');
                </script>
            </section>
        </main>
    </div>

    <!-- Traffic Detail Modal -->
    <div id="trafficDetailModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-traffic-modal">&times;</span>
            <h3>Traffic Log Details</h3>
            <div id="trafficModalContent">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
    
    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Trigger Details</h3>
            <div id="modalContent">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script src="/components/admin.js"></script>
    
    <!-- pgvector Diagnostics Script -->
    <script>
        // pgvector Status Check
        document.getElementById('checkPgvector')?.addEventListener('click', async function() {
            const button = this;
            const resultDiv = document.getElementById('pgvectorResult');
            const detailsDiv = document.getElementById('pgvectorDetails');
            
            button.disabled = true;
            button.textContent = 'Checking...';
            resultDiv.innerHTML = '<span style="color: #3b82f6;">üîÑ Running diagnostics...</span>';
            
            try {
                const response = await fetch('/api/admin/diagnostics/pgvector-status', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('sessionToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch pgvector status');
                }
                
                const data = await response.json();
                console.log('pgvector diagnostics:', data);
                
                // Update UI with results
                detailsDiv.style.display = 'block';
                
                // Update status badges
                updateStatusBadge('pgvectorInstalled', data.checks.extension_installed);
                updateStatusBadge('vectorTypeExists', data.checks.vector_type_exists);
                updateStatusBadge('vectorOperations', data.checks.vector_operations_work);
                
                // Update version
                document.getElementById('pgvectorVersion').textContent = 
                    data.checks.extension_version || 'Not installed';
                
                // Update statistics
                if (data.vector_statistics) {
                    const totalVectors = data.vector_statistics.top_tenants
                        .reduce((sum, t) => sum + parseInt(t.count), 0);
                    document.getElementById('totalVectorCount').textContent = totalVectors.toLocaleString();
                    document.getElementById('activeTenantCount').textContent = 
                        data.vector_statistics.total_tenants || '0';
                }
                
                // Check for issues
                const issues = [];
                if (!data.checks.extension_installed) {
                    issues.push('pgvector extension is not installed');
                }
                if (!data.checks.vector_type_exists) {
                    issues.push('Vector type is not available');
                }
                if (!data.checks.vector_operations_work) {
                    issues.push('Vector operations are not working');
                }
                
                if (issues.length > 0) {
                    document.getElementById('pgvectorErrors').style.display = 'block';
                    const errorsList = document.getElementById('pgvectorErrorsList');
                    errorsList.innerHTML = issues.map(issue => `<li>${issue}</li>`).join('');
                    document.getElementById('fixPgvector').style.display = 'inline-block';
                    resultDiv.innerHTML = '<span style="color: #dc2626;">‚ùå Issues detected with pgvector</span>';
                } else {
                    document.getElementById('pgvectorErrors').style.display = 'none';
                    resultDiv.innerHTML = '<span style="color: #10b981;">‚úÖ pgvector is working correctly</span>';
                }
                
            } catch (error) {
                console.error('pgvector check error:', error);
                resultDiv.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${error.message}</span>`;
            } finally {
                button.disabled = false;
                button.textContent = 'Check pgvector Status';
            }
        });
        
        // Attempt auto-fix
        document.getElementById('fixPgvector')?.addEventListener('click', async function() {
            if (!confirm('This will attempt to install pgvector extension. Continue?')) {
                return;
            }
            
            const button = this;
            button.disabled = true;
            button.textContent = 'Attempting fix...';
            
            try {
                const response = await fetch('/api/admin/diagnostics/fix-pgvector', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('sessionToken')}`
                    }
                });
                
                const data = await response.json();
                console.log('Fix attempt result:', data);
                
                if (data.final_status?.pgvector_installed) {
                    alert('‚úÖ pgvector has been successfully installed!');
                    // Re-run the check
                    document.getElementById('checkPgvector').click();
                } else {
                    alert('‚ö†Ô∏è Could not install pgvector automatically. Manual installation required.\n\nConnect to your database and run:\nCREATE EXTENSION IF NOT EXISTS vector;');
                }
                
            } catch (error) {
                console.error('Fix attempt error:', error);
                alert('Error attempting fix: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'üîß Attempt Auto-Fix';
            }
        });
        
        function updateStatusBadge(elementId, status) {
            const element = document.getElementById(elementId);
            if (element) {
                if (status) {
                    element.textContent = '‚úÖ Yes';
                    element.style.color = '#10b981';
                } else {
                    element.textContent = '‚ùå No';
                    element.style.color = '#dc2626';
                }
            }
        }
        
        // Auto-check on page load if in settings section
        window.addEventListener('load', function() {
            if (window.location.hash === '#settings') {
                setTimeout(() => {
                    document.getElementById('checkPgvector')?.click();
                }, 1000);
            }
        });
        
        // Check when switching to settings tab
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (this.getAttribute('href') === '#settings') {
                    setTimeout(() => {
                        const pgvectorDetails = document.getElementById('pgvectorDetails');
                        if (pgvectorDetails && pgvectorDetails.style.display === 'none') {
                            document.getElementById('checkPgvector')?.click();
                        }
                    }, 500);
                }
            });
        });
    </script>
</body>
</html>