<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Dashboard - Resolve</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@radix-ui/themes@3.0.0/styles.css">
    <link rel="stylesheet" href="/styles/fonts.css">
    <link rel="stylesheet" href="/styles/dashboard-styles.css">
    <link rel="stylesheet" href="/styles/action-button.css">
    <link rel="stylesheet" href="/styles/article-item.css">
    <link rel="stylesheet" href="/quikchat.css">
    <link rel="stylesheet" href="/dashboard-chat.css">
</head>
<body>
    <div class="rt-Theme" data-radius="medium" data-appearance="light">
        <div class="dashboard-layout">
            <%- include('partials/header', { currentPage: 'dashboard' }) %>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Include Left Sidebar Partial -->
                <%- include('partials/left-sidebar') %>

                <!-- Center - Chat Area -->
                <main class="chat-area">
                    <div class="chat-container">
                        <div class="chat-header">
                            <h1 class="chat-title season-heading">Ask Rita</h1>
                            <p class="chat-subtitle">
                                Build and manage your automation workflows with AI assistance
                            </p>
                        </div>

                        <!-- QuikChat Container (active) -->
                        <div id="quikchat-container" style="height: calc(100% - 120px); width: 100%;"></div>
                        
                        <!-- Jarvis Chat Container (disabled for now) -->
                        <div id="jarvis-chat-container" style="height: calc(100% - 120px); width: 100%; display: none;"></div>
                    </div>
                </main>

                <!-- Right Sidebar - Knowledge Base Articles -->
                <aside class="right-sidebar">
                    <!-- Share Link Box -->
                    <div class="share-chats-box">
                        <div class="share-header">
                            <h3 class="share-title">Share Assistant</h3>
                            <p class="share-description">
                                Invite your team members to use Ask Rita for workflow automation.
                            </p>
                        </div>
                        <button class="share-all-btn" id="share-all-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M18 8C19.6569 8 21 6.65685 21 5C21 3.34315 19.6569 2 18 2C16.3431 2 15 3.34315 15 5C15 6.65685 16.3431 8 18 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                <path d="M6 15C7.65685 15 9 13.6569 9 12C9 10.3431 7.65685 9 6 9C4.34315 9 3 10.3431 3 12C3 13.6569 4.34315 15 6 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                <path d="M18 22C19.6569 22 21 20.6569 21 19C21 17.3431 19.6569 16 18 16C16.3431 16 15 17.3431 15 19C15 20.6569 16.3431 22 18 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                <path d="M8.59 13.51L15.42 17.49M15.41 6.51L8.59 10.49" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                            Share invite link
                        </button>
                    </div>
                    
                    <!-- Knowledge Base Widget -->
                    <div class="knowledge-widget" style="padding: 20px; background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);">
                        <div class="knowledge-header" style="margin-bottom: 16px;">
                            <h3 class="share-title">Knowledge Base</h3>
                        </div>
                        
                        <!-- Upload Area -->
                        <div class="knowledge-upload" id="knowledge-upload-area" style="box-sizing: border-box; width: 100%; background: rgba(248, 250, 252, 0.5); border: 2px dashed rgba(0, 0, 0, 0.08); border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s ease; margin-bottom: 16px;" 
             onmouseover="this.style.background='rgba(248, 250, 252, 0.8)'; this.style.borderColor='rgba(78, 205, 196, 0.3)';" 
             onmouseout="this.style.background='rgba(248, 250, 252, 0.5)'; this.style.borderColor='rgba(0, 0, 0, 0.08)';">
                            <div class="upload-text" style="font-size: 12px; color: rgb(26, 26, 26); font-weight: 500; margin-bottom: 4px;">Drop files or click to upload</div>
                            <div class="upload-hint" style="font-size: 11px; color: rgba(0, 0, 0, 0.5);">PDF, DOC, TXT, MD â€¢ Max 100MB</div>
                        </div>
                        
                        <!-- Stats Grid -->
                        <div class="knowledge-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 12px; background: rgba(248, 250, 252, 0.8); border-radius: 6px; margin-bottom: 16px;">
                            <div class="stat-item" style="text-align: center;">
                                <span class="stat-value" style="font-size: 18px; font-weight: 600; color: rgb(0, 102, 255); display: block;">11</span>
                                <span class="stat-label" style="font-size: 10px; color: rgba(0, 0, 0, 0.5); text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px;">Articles</span>
                            </div>
                            <div class="stat-item" style="text-align: center;">
                                <span class="stat-value" style="font-size: 18px; font-weight: 600; color: rgb(0, 102, 255); display: block;">350</span>
                                <span class="stat-label" style="font-size: 10px; color: rgba(0, 0, 0, 0.5); text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px;">Vectors</span>
                            </div>
                            <div class="stat-item" style="text-align: center;">
                                <span class="stat-value" style="font-size: 18px; font-weight: 600; color: rgb(0, 102, 255); display: block;">89%</span>
                                <span class="stat-label" style="font-size: 10px; color: rgba(0, 0, 0, 0.5); text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px;">Accuracy</span>
                            </div>
                        </div>
                        
                        <!-- Recent Documents -->
                        <div class="knowledge-recent" style="margin-bottom: 16px;">
                            <div class="section-title" style="font-size: 11px; color: rgba(0, 0, 0, 0.5); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">RECENT UPLOADS</div>
                            <div id="recentUploadsContainer"></div>
                        </div>
                        
                        <!-- Articles List (Hidden container for loadKnowledgeBase function) -->
                        <div id="articles-list" style="display: none;"></div>
                        
                        <!-- Manage Button -->
                        <button class="action-btn action-btn-primary action-btn-medium action-btn-full knowledge-manage-btn" id="knowledge-manage-btn">
                            <span class="action-btn-text">Manage Knowledge Base â†’</span>
                        </button>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <script>
        // Jarvis iframe injection function (disabled - using QuikChat now)
        /* 
        function injectEspressiveWidget(options) {
            const {
                containerElement,
                tenantUrl,
                chatVersion,
                channelParameters,
                guestMode,
                initialIntentId,
            } = options;
            
            // Prevent duplicate injection
            if (document.getElementById('espressive-container')) {
                console.warn('Espressive container already exists on the page.');
                return;
            }

            // Ensure a valid container is provided
            if (!containerElement || !(containerElement instanceof HTMLElement)) {
                console.error('A valid container element must be provided.');
                return;
            }

            // Create the wrapper div
            const wrapperDiv = document.createElement('div');
            wrapperDiv.id = 'espressive-container';
            wrapperDiv.style.width = '100%';
            wrapperDiv.style.height = '100%';

            // Construct the iframe URL
            const params = new URLSearchParams({
                client: 'widget',
                chat_version: chatVersion,
            });

            if (guestMode) {
                params.append('otc', guestMode);
            }

            if (initialIntentId) {
                params.append('initial_intent_id', initialIntentId);
            }

            for (const key in channelParameters) {
                if (Object.hasOwnProperty.call(channelParameters, key)) {
                    params.append(`widget.${key}`, channelParameters[key]);
                }
            }
            params.append('widget.parent-origin', window.location.origin);
            params.append('widget.iframe-origin', `https://${tenantUrl}`);
            const iframeSrc = `https://${tenantUrl}/portal?${params.toString()}`;

            // Create the iframe
            const iframe = document.createElement('iframe');
            iframe.src = iframeSrc;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.allow = 'clipboard-write';

            // Append iframe to the wrapper
            wrapperDiv.appendChild(iframe);

            // Append the wrapper to the container
            containerElement.appendChild(wrapperDiv);
        }
        */

        // Check authentication on page load
        (function checkAuth() {
            // Authentication is now handled by server-side cookie
            // The requireAuth middleware will redirect if not authenticated
            // We only need to check for local storage for backwards compatibility
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            
            // Clean up URL if there's still a token parameter (remove it)
            if (urlToken) {
                window.history.replaceState({}, document.title, '/dashboard');
            }
            
            // Load user info and get tenant ID
            const userSession = localStorage.getItem('userSession');
            const userRole = localStorage.getItem('userRole');
            
            // Show Users button for admin users
            if (userRole === 'tenant-admin') {
                const usersNavBtn = document.getElementById('users-nav-btn');
                if (usersNavBtn) {
                    usersNavBtn.style.display = 'block';
                }
            }
            
            if (userSession) {
                const user = JSON.parse(userSession);
                // Update user avatar with first letter of name
                const userInitial = document.getElementById('userInitial');
                const dropdownAvatar = document.getElementById('dropdownAvatar');
                if (user.fullName) {
                    const initial = user.fullName.charAt(0).toUpperCase();
                    if (userInitial) {
                        userInitial.textContent = initial;
                    }
                    if (dropdownAvatar) {
                        dropdownAvatar.textContent = initial;
                    }
                }
                
                // Update dropdown info
                const dropdownName = document.getElementById('dropdownName');
                const dropdownEmail = document.getElementById('dropdownEmail');
                if (dropdownName) {
                    dropdownName.textContent = user.fullName || user.email;
                }
                if (dropdownEmail) {
                    dropdownEmail.textContent = user.email;
                }
                
                // Fetch user info to get tenant ID
                fetch('/api/user/info')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.tenantId) {
                            // Update tenant ID display
                            const tenantIdDisplay = document.getElementById('tenantIdDisplay');
                            if (tenantIdDisplay) {
                                tenantIdDisplay.textContent = data.tenantId;
                                tenantIdDisplay.title = 'Click to copy: ' + data.tenantId;
                            }
                            
                            // Store for Jarvis widget
                            localStorage.setItem('userTenantId', data.tenantId);
                            window.userTenantId = data.tenantId;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching user info:', error);
                    });
            }
        })();
        
        // Dropdown functions
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userAvatar = document.querySelector('.user-avatar');
            const dropdown = document.getElementById('userDropdown');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        function copyTenantId() {
            const tenantIdElement = document.getElementById('tenantIdDisplay');
            const tenantId = tenantIdElement.textContent;
            
            if (tenantId && tenantId !== 'Loading...') {
                navigator.clipboard.writeText(tenantId).then(() => {
                    alert('Tenant ID copied to clipboard');
                }).catch(() => {
                    alert('Failed to copy tenant ID');
                });
            }
            
            // Close dropdown
            document.getElementById('userDropdown').style.display = 'none';
        }
        
        function logout() {
            localStorage.removeItem('userSession');
            localStorage.removeItem('userTenantId');
            sessionStorage.clear();
            window.location.href = '/';
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                // Add sending animation
                const sendBtn = document.querySelector('.send-button');
                sendBtn.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    sendBtn.style.transform = 'scale(1)';
                    input.value = '';
                    
                    // Here you would typically send the message to your backend
                    console.log('Message sent:', message);
                }, 150);
            }
        }

        // Function to load and display tickets in the Knowledge Base
        async function loadKnowledgeBase() {
            try {
                const response = await fetch('/api/tickets?limit=5', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch tickets');
                }
                
                const data = await response.json();
                const articlesList = document.getElementById('articles-list');
                
                if (data.success && data.tickets.length > 0) {
                    // Clear only non-document items (preserve RAG documents)
                    const existingDocs = Array.from(articlesList.querySelectorAll('[data-document-id]'));
                    articlesList.innerHTML = '';
                    
                    // Re-add existing documents first
                    existingDocs.forEach(doc => articlesList.appendChild(doc));
                    
                    // Create article items for each ticket
                    data.tickets.forEach(ticket => {
                        const articleItem = document.createElement('div');
                        articleItem.className = 'article-item';
                        
                        // Determine icon color based on priority
                        const iconColor = ticket.priority === 'High' ? '#FF6B6B' : 
                                        ticket.priority === 'Medium' ? '#FFB366' : 
                                        '#4ECDC4';
                        
                        articleItem.innerHTML = `
                            <div class="article-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="${iconColor}" stroke-width="2"></path>
                                    <polyline points="14,2 14,8 20,8" stroke="${iconColor}" stroke-width="2"></polyline>
                                </svg>
                            </div>
                            <div class="article-content">
                                <h4 class="article-title">${escapeHtml(ticket.title || 'Untitled')}</h4>
                                <p class="article-description">${escapeHtml(truncateText(ticket.description || 'No description', 60))}</p>
                                <div style="margin-top: 4px; font-size: 10px; color: #8B8B9F; text-transform: uppercase;">
                                    ${ticket.metadata?.category || ticket.priority || 'General'} â€¢ ${ticket.status || 'Open'}
                                </div>
                            </div>
                        `;
                        
                        // Make the item clickable
                        articleItem.style.cursor = 'pointer';
                        articleItem.onclick = () => showTicketDetails(ticket);
                        
                        articlesList.appendChild(articleItem);
                    });
                    
                    // Update the count (tickets + documents)
                    const statNumber = document.querySelector('.stat-number');
                    if (statNumber) {
                        const docCount = articlesList.querySelectorAll('[data-document-id]').length;
                        statNumber.textContent = data.pagination.total + docCount;
                    }
                } else if (data.tickets.length === 0) {
                    // Preserve existing documents
                    const existingDocs = Array.from(articlesList.querySelectorAll('[data-document-id]'));
                    
                    // Only show empty state if there are no documents either
                    if (existingDocs.length === 0) {
                        articlesList.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #8B8B9F;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="margin: 0 auto 12px; opacity: 0.5;">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="1.5"></path>
                                    <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="1.5"></polyline>
                                </svg>
                                <p>No articles yet</p>
                                <p style="font-size: 12px; margin-top: 8px;">Upload files to populate your knowledge base</p>
                            </div>
                        `;
                    } else {
                        // Clear and re-add only documents (no tickets to add)
                        articlesList.innerHTML = '';
                        existingDocs.forEach(doc => articlesList.appendChild(doc));
                    }
                    
                    // Update count to include documents
                    const statNumber = document.querySelector('.stat-number');
                    if (statNumber) {
                        statNumber.textContent = existingDocs.length;
                    }
                }
            } catch (error) {
                console.error('Error loading knowledge base:', error);
                const articlesList = document.getElementById('articles-list');
                articlesList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #FF6B6B;">
                        <p>Failed to load articles</p>
                        <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper function to truncate text
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        // Initialize Jarvis widget on page load
        // Function to load documents from RAG system
        async function loadRagDocuments() {
            try {
                const response = await fetch('/api/rag/documents', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.documents && result.documents.length > 0) {
                        const articlesList = document.getElementById('articles-list');
                        const articleItem = new ArticleItem();
                        
                        // Remove loading placeholder if it exists
                        const loadingPlaceholder = articlesList.querySelector('.loading-placeholder');
                        if (loadingPlaceholder) {
                            loadingPlaceholder.remove();
                        }
                        
                        // Add each document to the list using the component
                        result.documents.forEach(doc => {
                            const docItem = articleItem.createElement({
                                documentId: doc.document_id,
                                filename: doc.original_filename || doc.document_id,
                                status: doc.status || 'ready',
                                showDeleteButton: true,
                                showRetryButton: doc.status === 'failed',
                                onDelete: (docId) => deleteDocument(docId),
                                onRetry: (docId, element) => retryDocument(docId, element)
                            });
                            
                            articlesList.appendChild(docItem);
                            
                            // If processing, start polling for status
                            if (doc.status === 'processing') {
                                setTimeout(() => checkDocumentStatus(doc.document_id, docItem), 5000);
                            }
                        });
                        
                        // Update the article count
                        const statNumber = document.querySelector('.stat-number');
                        if (statNumber) {
                            const currentCount = parseInt(statNumber.textContent) || 0;
                            statNumber.textContent = currentCount + result.documents.length;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading RAG documents:', error);
            }
        }
        
        // Function to load recent uploads (last 3 documents)
        async function updateKnowledgeStats() {
            try {
                // Get tenant ID
                const tenantId = window.userTenantId || localStorage.getItem('userTenantId') || 'default-tenant';
                
                // Fetch actual stats from the backend with tenant ID
                const response = await fetch(`/api/rag/tenant/${tenantId}/vectors/stats`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    
                    // Update the UI with real numbers
                    const articlesElement = document.querySelector('.knowledge-stats .stat:nth-child(1) .value');
                    const vectorsElement = document.querySelector('.knowledge-stats .stat:nth-child(2) .value');
                    const accuracyElement = document.querySelector('.knowledge-stats .stat:nth-child(3) .value');
                    
                    if (articlesElement) articlesElement.textContent = stats.document_count || '0';
                    if (vectorsElement) vectorsElement.textContent = stats.vector_count || '0';
                    if (accuracyElement) accuracyElement.textContent = `${stats.coverage_percentage || '0'}%`;
                }
            } catch (error) {
                // Silently handle error - stats are non-critical
            }
        }

        async function loadRecentUploads() {
            const recentUploadsContainer = document.getElementById('recentUploadsContainer');
            if (!recentUploadsContainer) return;
            
            try {
                const response = await fetch('/api/rag/documents', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.documents && result.documents.length > 0) {
                        const articleItem = new ArticleItem();
                        
                        // Clear container
                        recentUploadsContainer.innerHTML = '';
                        
                        // Sort by created_at descending (most recent first) and take only first 3
                        const recentDocs = result.documents
                            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                            .slice(0, 3);
                        
                        // Render each document
                        recentDocs.forEach(doc => {
                            const itemElement = articleItem.createElement({
                                documentId: doc.document_id,
                                filename: doc.original_filename || doc.document_id,
                                status: doc.status || 'ready',
                                customDescription: doc.status === 'processing' ? 'Processing...' : 'Ready',
                                showDeleteButton: false,  // No delete button
                                showRetryButton: false,
                                onClick: (docId, element) => {
                                    viewDocument(docId);
                                }
                            });
                            
                            // Make it more compact with correct icon spacing
                            itemElement.style.padding = '8px';  // Outer padding
                            itemElement.style.marginBottom = '4px';
                            
                            // Fix icon alignment and spacing
                            const iconElement = itemElement.querySelector('.article-icon');
                            if (iconElement) {
                                // Remove internal padding and center icon vertically
                                iconElement.style.paddingTop = '0';
                                iconElement.style.alignItems = 'center';
                                iconElement.style.height = 'auto';
                                iconElement.style.marginTop = '0';
                                // Set icon width and margins for balanced spacing
                                iconElement.style.width = '16px';  // Icon width
                                iconElement.style.marginLeft = '-4px';  // Partial offset to avoid touching border
                                iconElement.style.marginRight = '0px';  // Results in ~12px total spacing
                            }
                            
                            // Add dynamic text truncation for title
                            const titleElement = itemElement.querySelector('.article-title');
                            if (titleElement) {
                                titleElement.style.whiteSpace = 'nowrap';
                                titleElement.style.overflow = 'hidden';
                                titleElement.style.textOverflow = 'ellipsis';
                                titleElement.style.maxWidth = 'calc(100% - 28px)'; // Account for icon + spacing
                            }
                            
                            // Add dynamic text truncation for description
                            const descElement = itemElement.querySelector('.article-description');
                            if (descElement) {
                                descElement.style.whiteSpace = 'nowrap';
                                descElement.style.overflow = 'hidden';
                                descElement.style.textOverflow = 'ellipsis';
                                descElement.style.maxWidth = 'calc(100% - 28px)'; // Same as title
                            }
                            
                            // Hide the status text line to keep it 2 lines
                            const statusElement = itemElement.querySelector('.article-status');
                            if (statusElement) {
                                statusElement.style.display = 'none';
                            }
                            
                            recentUploadsContainer.appendChild(itemElement);
                        });
                        
                        // Update the stats grid with real counts
                        const statValue = document.querySelector('.knowledge-stats .stat-value');
                        if (statValue) {
                            statValue.textContent = result.documents.length;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading recent uploads:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Load knowledge base articles
            loadKnowledgeBase();
            // Also load RAG documents
            loadRagDocuments();
            // Load recent uploads for the knowledge widget
            loadRecentUploads();
            // Load knowledge stats with real numbers
            updateKnowledgeStats();
            // Setup SSE for real-time knowledge base updates
            setupDocumentStatusSSE();
            
            setTimeout(() => {
                const chatContainer = document.getElementById('jarvis-chat-container');
                if (chatContainer) {
                    // Wait a bit for tenant ID to be fetched
                    setTimeout(() => {
                        // Get tenant ID from localStorage or window
                        const tenantId = window.userTenantId || localStorage.getItem('userTenantId') || 'default-tenant';
                        const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        
                        console.log('Initializing Jarvis with tenant ID:', tenantId);
                        
                        // Commented out - using QuikChat now
                        /*
                        injectEspressiveWidget({
                            containerElement: chatContainer,
                            tenantUrl: 'resolvejarvisdev.espressive.com',
                            chatVersion: 2,
                            channelParameters: { 
                                tenant_id: tenantId,  // Use actual UUID tenant ID
                                session_id: sessionId
                            }, 
                            guestMode: 'DOGAFLA' // tenant must have guest mode enabled
                        });
                        console.log('Jarvis widget injected successfully with tenant ID:', tenantId);
                        */
                    }, 1500); // Wait for user info to be fetched
                } else {
                    console.error('Chat container element not found');
                }
            }, 100);
        });
        
        // Check document processing status
        async function checkDocumentStatus(documentId, itemElement) {
            try {
                const response = await fetch(`/api/rag/document-status/${documentId}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const doc = result.document;
                    const articleItem = new ArticleItem();
                    
                    // Update UI based on status
                    if (doc.status === 'ready') {
                        articleItem.updateStatus(itemElement, 'ready', 'Document processed successfully');
                    } else if (doc.status === 'failed') {
                        articleItem.updateStatus(itemElement, 'failed');
                        
                        // Add retry handler to the new retry button
                        const retryBtn = itemElement.querySelector('[data-action="retry"]');
                        if (retryBtn) {
                            retryBtn.onclick = (e) => {
                                e.stopPropagation();
                                retryDocument(documentId, itemElement);
                            };
                        }
                    } else {
                        // Still processing, check again
                        setTimeout(() => checkDocumentStatus(documentId, itemElement), 5000);
                    }
                }
            } catch (error) {
                console.error('Error checking document status:', error);
                // Retry checking after delay
                setTimeout(() => checkDocumentStatus(documentId, itemElement), 10000);
            }
        }
        
        // Delete document function
        async function deleteDocument(documentId) {
            // Get document info for the modal
            const docElement = document.querySelector(`[data-document-id="${documentId}"]`);
            const docTitle = docElement?.querySelector('.article-title')?.innerText || 'this document';
            
            // Create deletion modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header" style="border-bottom: none; padding-bottom: 0;">
                        <h3 class="modal-title" style="color: #FF6B6B; font-size: 20px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="vertical-align: middle; margin-right: 8px;">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 8v4m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Delete Document
                        </h3>
                    </div>
                    <div class="modal-body" style="padding-top: 12px;">
                        <p style="color: #4B5563; margin: 0 0 8px 0;">Are you sure you want to delete this document?</p>
                        <p style="color: #6B7280; font-size: 14px; margin: 0;">
                            <strong style="color: #374151;">"${escapeHtml(docTitle)}"</strong> will be permanently removed from your knowledge base.
                        </p>
                    </div>
                    <div class="modal-footer" style="padding: 20px 24px; gap: 12px;">
                        <button class="modal-btn secondary modal-close-generic">
                            Cancel
                        </button>
                        <button class="modal-btn primary" style="background: #FF6B6B;" id="confirmDelete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align: middle; margin-right: 6px;">
                                <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.appendChild(modal);
            
            // Show modal with animation
            setTimeout(() => modal.classList.add('show'), 10);
            
            // Handle delete confirmation
            modal.querySelector('#confirmDelete').onclick = async function() {
                try {
                    const response = await fetch(`/api/rag/document/${documentId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        // Remove modal
                        modal.remove();
                        
                        // Remove the item from UI
                        const itemElement = document.querySelector(`[data-document-id="${documentId}"]`);
                        if (itemElement) {
                            itemElement.remove();
                            
                            // Update article count
                            const statNumber = document.querySelector('.stat-number');
                            if (statNumber) {
                                const currentCount = parseInt(statNumber.textContent) || 0;
                                if (currentCount > 0) {
                                    statNumber.textContent = currentCount - 1;
                                }
                            }
                        }
                        
                        // Refresh the recent uploads list
                        setTimeout(() => loadRecentUploads(), 350);
                        
                        // Show success notification
                        const notification = document.createElement('div');
                        notification.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: linear-gradient(135deg, #10B981, #059669);
                            color: white;
                            padding: 12px 20px;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                            z-index: 10000;
                            animation: slideIn 0.3s ease-out;
                        `;
                        notification.textContent = 'Document deleted successfully';
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.style.animation = 'slideIn 0.3s ease-out reverse';
                            setTimeout(() => notification.remove(), 300);
                        }, 3000);
                    } else {
                        throw new Error('Failed to delete document');
                    }
                } catch (error) {
                    console.error('Error deleting document:', error);
                    modal.remove();
                    
                    // Show error notification
                    const errorNotification = document.createElement('div');
                    errorNotification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #EF4444, #DC2626);
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                        z-index: 10000;
                        animation: slideIn 0.3s ease-out;
                    `;
                    errorNotification.textContent = 'Failed to delete document. Please try again.';
                    document.body.appendChild(errorNotification);
                    
                    setTimeout(() => {
                        errorNotification.style.animation = 'slideIn 0.3s ease-out reverse';
                        setTimeout(() => errorNotification.remove(), 300);
                    }, 3000);
                }
            };
        }
        
        // Retry failed document processing
        async function retryDocument(documentId, itemElement) {
            try {
                const response = await fetch(`/api/rag/document-retry/${documentId}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // Update UI to show processing
                    itemElement.classList.remove('failed');
                    itemElement.classList.add('processing');
                    itemElement.style.opacity = '0.8';
                    
                    // Update the icon color back to yellow
                    const svg = itemElement.querySelector('.article-icon svg');
                    if (svg) {
                        svg.querySelectorAll('path, polyline').forEach(el => {
                            el.setAttribute('stroke', '#FFC107');
                        });
                    }
                    
                    // Update the description and status
                    const description = itemElement.querySelector('.article-description');
                    if (description) {
                        description.textContent = 'Reprocessing document...';
                    }
                    
                    const statusDiv = itemElement.querySelector('.article-content > div:last-child');
                    if (statusDiv) {
                        statusDiv.style.color = '#FFC107';
                        statusDiv.textContent = 'PROCESSING';
                    }
                    
                    // Start checking status
                    setTimeout(() => checkDocumentStatus(documentId, itemElement), 5000);
                }
            } catch (error) {
                console.error('Error retrying document:', error);
            }
        }
        
        function handleUpload() {
            // Create file input and trigger click
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = false; // Single file upload per plan requirement
            input.accept = '.pdf,.doc,.docx,.txt,.md,.html,.csv,.jpg,.jpeg,.png,.gif,.bmp,.tiff,.webp,.odt,.ods,.odp,.epub,.xml,.json,.tex,.xps,.mobi,.svg,.docm,.dotx,.pptm,.xlsm,.xlsb,.vsdx,.vsd,.pub,.mht,.mhtml,.eml,.msg';
            input.onchange = async (e) => {
                const files = e.target.files;
                if (files.length > 0) {
                    console.log('Selected file:', files[0]);
                    // Process the file directly
                    await uploadDocument(files[0]);
                }
            };
            input.click();
        }
        
        // Document status monitoring with SSE
        let documentStatusSSE = null;
        const documentStatusMonitors = new Map(); // Track which documents we're monitoring
        let knowledgeSSERetryCount = 0;
        const MAX_KNOWLEDGE_SSE_RETRIES = 3;
        
        function setupDocumentStatusSSE() {
            // Use the same SSE connection pattern as chat
            // Connect to a knowledge base events stream
            if (documentStatusSSE) {
                return;
            }
            
            // Get tenant ID from the page or session
            const tenantId = window.tenantId || document.querySelector('[data-tenant-id]')?.dataset.tenantId;
            
            // Create SSE connection for knowledge base updates
            // Using similar pattern to chat-stream
            documentStatusSSE = new EventSource('/api/rag/knowledge-stream');
            
            documentStatusSSE.onopen = () => {
                // Reset retry count on successful connection
                knowledgeSSERetryCount = 0;
            };
            
            documentStatusSSE.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    // Handle different event types
                    if (data.type === 'document-status' || data.type === 'document-vectorized') {
                        updateDocumentUI(data.document_id, data.status, data.metadata);
                        // Update stats when vectorization is complete
                        if (data.status === 'vectorized') {
                            updateKnowledgeStats();
                        }
                        // Refresh document list when status is 'ready' (document processed)
                        if (data.status === 'ready') {
                            loadRecentUploads();
                            loadRagDocuments();
                            updateKnowledgeStats();
                        }
                    } else if (data.type === 'document-uploaded') {
                        // Refresh recent uploads
                        loadRecentUploads();
                        updateKnowledgeStats();
                    } else if (data.type === 'document-processed') {
                        updateDocumentUI(data.document_id, 'ready', data);
                        // Update stats
                        updateKnowledgeStats();
                    } else if (data.type === 'connected' || data.type === 'heartbeat') {
                        // Ignore heartbeat messages
                    }
                } catch (error) {
                    console.error('Error processing knowledge update:', error);
                }
            };
            
            documentStatusSSE.onerror = (error) => {
                // Silently handle SSE errors - try to reconnect
                
                // Only check auth if we've had multiple failures
                knowledgeSSERetryCount++;
                if (knowledgeSSERetryCount > 2) {
                    // After multiple failures, check if this is an authentication error
                    const tenantId = window.userTenantId || localStorage.getItem('userTenantId') || 'default-tenant';
                    fetch(`/api/rag/tenant/${tenantId}/vectors/stats`, { credentials: 'include' })
                        .then(response => {
                            if (response.status === 401 || response.status === 403) {
                                console.error('ðŸš« Authentication failed after multiple retries - redirecting to signin');
                                // Close the SSE connection
                                if (documentStatusSSE) {
                                    documentStatusSSE.close();
                                    documentStatusSSE = null;
                                }
                                // Redirect to signin page
                                window.location.href = '/signin';
                            } else {
                                // Not an auth error, try to reconnect with exponential backoff
                                if (knowledgeSSERetryCount <= MAX_KNOWLEDGE_SSE_RETRIES && documentStatusSSE) {
                                    const delay = Math.min(5000 * Math.pow(2, knowledgeSSERetryCount - 1), 30000);
                                    setTimeout(() => {
                                        documentStatusSSE = null;
                                        setupDocumentStatusSSE();
                                    }, delay);
                                }
                            }
                        })
                        .catch(() => {
                            // Network error, try to reconnect
                            if (knowledgeSSERetryCount <= MAX_KNOWLEDGE_SSE_RETRIES && documentStatusSSE) {
                                const delay = Math.min(5000 * Math.pow(2, knowledgeSSERetryCount - 1), 30000);
                                setTimeout(() => {
                                    documentStatusSSE = null;
                                    setupDocumentStatusSSE();
                                }, delay);
                            }
                        });
                } else {
                    // First couple failures, just retry without auth check
                    if (knowledgeSSERetryCount <= MAX_KNOWLEDGE_SSE_RETRIES && documentStatusSSE) {
                        const delay = Math.min(5000 * Math.pow(2, knowledgeSSERetryCount - 1), 30000);
                        setTimeout(() => {
                            documentStatusSSE = null;
                            setupDocumentStatusSSE();
                        }, delay);
                    } else {
                        if (documentStatusSSE) {
                            documentStatusSSE.close();
                            documentStatusSSE = null;
                        }
                    }
                }
            };
        }
        
        function monitorDocumentStatus(documentId, element) {
            // Add to monitoring list
            documentStatusMonitors.set(documentId, element);
            
            // Ensure SSE is connected
            if (!documentStatusSSE || documentStatusSSE.readyState === EventSource.CLOSED) {
                setupDocumentStatusSSE();
            }
            
            // Do an immediate status check
            checkDocumentStatus(documentId, element);
        }
        
        async function checkDocumentStatus(documentId, element) {
            try {
                const response = await fetch(`/api/rag/document-status/${documentId}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateDocumentUI(documentId, data.status, data);
                }
            } catch (error) {
                console.error('Error checking document status:', error);
            }
        }
        
        function updateDocumentUI(documentId, status, metadata) {
            const element = documentStatusMonitors.get(documentId);
            if (!element) return;
            
            // Update the status in the UI element
            const statusElement = element.querySelector('.status-indicator');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.className = `status-indicator status-${status}`;
            }
            
            // If ready, completed, vectorized or failed, stop monitoring
            if (status === 'ready' || status === 'completed' || status === 'vectorized' || status === 'failed') {
                documentStatusMonitors.delete(documentId);
                
                // Log when monitoring is complete for this document
                if (documentStatusMonitors.size === 0) {
                    console.log('ðŸ“‹ All document monitoring complete');
                }
                
                // Update button states
                const retryButton = element.querySelector('.retry-button');
                if (retryButton) {
                    retryButton.style.display = status === 'failed' ? 'inline-block' : 'none';
                }
            }
        }
        
        // Helper function to show error modal
        function showErrorModal(title, message) {
            // Remove any existing modal
            const existingModal = document.getElementById('error-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHTML = `
                <div id="error-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: slideIn 0.3s ease;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="#ef4444" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #1f2937;">${title}</h3>
                        </div>
                        <p style="margin: 0 0 20px 0; color: #6b7280; line-height: 1.5;">${message}</p>
                        <button data-close-error-modal style="width: 100%; padding: 10px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s;" 
                                onmouseover="this.style.background='#2563eb'" 
                                onmouseout="this.style.background='#3b82f6'">
                            Understood
                        </button>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add animation CSS if not exists
            if (!document.querySelector('#modal-animation-styles')) {
                const style = document.createElement('style');
                style.id = 'modal-animation-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateY(-20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        async function uploadDocument(file) {
            // Show loading state in the upload area
            const uploadButton = document.querySelector('.knowledge-upload');
            if (uploadButton) {
                uploadButton.style.opacity = '0.6';
                uploadButton.style.pointerEvents = 'none';
                uploadButton.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 12px; color: rgb(26, 26, 26); font-weight: 500;">
                        <svg class="spinner" width="16" height="16" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.4" stroke-dashoffset="10"></circle>
                        </svg>
                        <span>Uploading...</span>
                    </div>
                `;
            }
            
            // Add spinner animation CSS if not exists
            if (!document.querySelector('#spinner-styles')) {
                const style = document.createElement('style');
                style.id = 'spinner-styles';
                style.textContent = `
                    @keyframes spin { to { transform: rotate(360deg); } }
                    .spinner { animation: spin 1s linear infinite; display: inline-block; }
                `;
                document.head.appendChild(style);
            }
            
            // Prepare form data - single file upload
            const formData = new FormData();
            formData.append('document', file); // Single file as 'document'
            
            try {
                // Upload document to RAG API
                const response = await fetch('/api/rag/upload-document', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include' // Include cookies with the request
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update knowledge base UI to show processing status
                    const articlesList = document.getElementById('articles-list');
                    if (articlesList) {
                        // Remove loading placeholder if it exists
                        const loadingPlaceholder = articlesList.querySelector('.loading-placeholder');
                        if (loadingPlaceholder) {
                            loadingPlaceholder.remove();
                        }
                        
                        // Create new article item using the component
                        const articleItem = new ArticleItem();
                        const newItem = articleItem.createElement({
                            documentId: result.document_id,
                            filename: file.name,
                            status: 'uploading',
                            showDeleteButton: true,
                            onDelete: (docId) => deleteDocument(docId)
                        });
                        
                        articlesList.insertBefore(newItem, articlesList.firstChild);
                        
                        // Update the article count
                        const statNumber = document.querySelector('.stat-number');
                        if (statNumber) {
                            const currentCount = parseInt(statNumber.textContent) || 0;
                            statNumber.textContent = currentCount + 1;
                        }
                        
                        // Monitor document status with SSE
                        monitorDocumentStatus(result.document_id, newItem);
                    }
                    
                    // Update recent uploads
                    await loadRecentUploads();
                    
                    console.log('Document uploaded successfully:', result.document_id);
                } else {
                    const errorText = await response.text();
                    console.error('Upload failed:', errorText);
                    
                    // Parse error message if it's JSON
                    let errorMessage = errorText;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error || errorJson.message || errorText;
                    } catch (e) {
                        // Not JSON, use as-is
                    }
                    
                    showErrorModal('Upload Failed', errorMessage);
                }
            } catch (error) {
                console.error('Error uploading document:', error);
                showErrorModal('Upload Error', 'Failed to upload document. Please check your connection and try again.');
            } finally {
                // Restore upload button
                if (uploadButton) {
                    uploadButton.style.opacity = '1';
                    uploadButton.style.pointerEvents = 'auto';
                    uploadButton.innerHTML = `
                        <div class="upload-text" style="font-size: 12px; color: rgb(26, 26, 26); font-weight: 500; margin-bottom: 4px;">Drop files or click to upload</div>
                        <div class="upload-hint" style="font-size: 11px; color: rgba(0, 0, 0, 0.5);">PDF, DOC, TXT, MD â€¢ Max 100MB</div>
                    `;
                }
            }
        }
        
        function openKnowledgeManagement() {
            console.log('Opening knowledge management page...');
            // Navigate to knowledge management page
            window.location.href = '/knowledge';
        }
        
        function openAddModal() {
            // Create a hidden file input for document upload
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = false; // Single file upload per plan requirement
            // Comprehensive list of supported file types
            fileInput.accept = '.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.rtf,.html,.htm,.csv,.txt,.jpg,.jpeg,.png,.gif,.bmp,.tiff,.webp,.odt,.ods,.odp,.epub,.md,.xml,.json,.tex,.xps,.mobi,.svg,.docm,.dotx,.pptm,.xlsm,.xlsb,.vsdx,.vsd,.pub,.mht,.mhtml,.eml,.msg';
            
            // Handle file selection
            fileInput.addEventListener('change', async function(e) {
                if (e.target.files.length > 0) {
                    const files = Array.from(e.target.files);
                    
                    // Show loading state in the Add More button
                    const addButton = document.querySelector('.action-btn');
                    const originalHTML = addButton.innerHTML;
                    addButton.innerHTML = '<svg class="spinner" width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.4" stroke-dashoffset="10"></circle></svg> Uploading...';
                    addButton.disabled = true;
                    
                    // Add spinner animation CSS if not exists
                    if (!document.querySelector('#spinner-styles')) {
                        const style = document.createElement('style');
                        style.id = 'spinner-styles';
                        style.textContent = `
                            @keyframes spin { to { transform: rotate(360deg); } }
                            .spinner { animation: spin 1s linear infinite; display: inline-block; }
                        `;
                        document.head.appendChild(style);
                    }
                    
                    // Prepare form data - single file upload
                    const formData = new FormData();
                    formData.append('document', files[0]); // Single file as 'document'
                    
                    try {
                        // Upload document to RAG API
                        const response = await fetch('/api/rag/upload-document', {
                            method: 'POST',
                            body: formData,
                            credentials: 'include' // Include cookies with the request
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            
                            // Update knowledge base UI to show processing status
                            const articlesList = document.getElementById('articles-list');
                            if (articlesList) {
                                // Remove loading placeholder if it exists
                                const loadingPlaceholder = articlesList.querySelector('.loading-placeholder');
                                if (loadingPlaceholder) {
                                    loadingPlaceholder.remove();
                                }
                                
                                // Create new article item using the component
                                const articleItem = new ArticleItem();
                                const newItem = articleItem.createElement({
                                    documentId: result.document_id,
                                    filename: files[0].name,
                                    status: 'uploading',
                                    showDeleteButton: true,
                                    onDelete: (docId) => deleteDocument(docId)
                                });
                                
                                articlesList.insertBefore(newItem, articlesList.firstChild);
                                
                                // Update the article count
                                const statNumber = document.querySelector('.stat-number');
                                if (statNumber) {
                                    const currentCount = parseInt(statNumber.textContent) || 0;
                                    statNumber.textContent = currentCount + 1;
                                }
                                
                                // Refresh the recent uploads list to show the new document at the top
                                loadRecentUploads();
                                
                                // Poll for status updates
                                if (result.document_id) {
                                    setTimeout(() => checkDocumentStatus(result.document_id, newItem), 5000);
                                }
                            }
                            
                            // Show success notification
                            const notification = document.createElement('div');
                            notification.style.cssText = `
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background: linear-gradient(135deg, #10B981, #059669);
                                color: white;
                                padding: 16px 24px;
                                border-radius: 8px;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                                z-index: 10000;
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                animation: slideIn 0.3s ease-out;
                            `;
                            
                            notification.innerHTML = `
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <div>
                                    <div style="font-weight: 600;">Upload Successful</div>
                                    <div style="font-size: 12px; opacity: 0.9;">
                                        ${files.length} file(s) uploaded â€¢ 
                                        ${result.csvRowCount || 0} rows processed â€¢ 
                                        ${result.ticketsImported || 0} tickets imported
                                    </div>
                                </div>
                            `;
                            
                            // Add animation styles
                            if (!document.querySelector('#notification-styles')) {
                                const style = document.createElement('style');
                                style.id = 'notification-styles';
                                style.textContent = `
                                    @keyframes slideIn {
                                        from { transform: translateX(100%); opacity: 0; }
                                        to { transform: translateX(0); opacity: 1; }
                                    }
                                `;
                                document.head.appendChild(style);
                            }
                            
                            document.body.appendChild(notification);
                            
                            // Log webhook details for debugging
                            console.log('CSV Upload Success:', {
                                callbackUrl: result.callbackUrl,
                                webhookId: result.webhookId,
                                csvRowCount: result.csvRowCount,
                                ticketsImported: result.ticketsImported,
                                files: files.map(f => f.name)
                            });
                            
                            // Remove notification after 5 seconds
                            setTimeout(() => {
                                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                                setTimeout(() => notification.remove(), 300);
                            }, 5000);
                            
                            // Don't reload knowledge base for document uploads - it would clear RAG documents
                            // Documents are already added to the UI above
                            
                        } else {
                            throw new Error(`Upload failed: ${response.statusText}`);
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        
                        // Show error notification
                        const notification = document.createElement('div');
                        notification.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: linear-gradient(135deg, #EF4444, #DC2626);
                            color: white;
                            padding: 16px 24px;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                            z-index: 10000;
                            display: flex;
                            align-items: center;
                            gap: 12px;
                        `;
                        
                        notification.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 8v4m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <div>
                                <div style="font-weight: 600;">Upload Failed</div>
                                <div style="font-size: 12px; opacity: 0.9;">${error.message}</div>
                            </div>
                        `;
                        
                        document.body.appendChild(notification);
                        
                        // Remove notification after 5 seconds
                        setTimeout(() => notification.remove(), 5000);
                    } finally {
                        // Restore button state
                        addButton.innerHTML = originalHTML;
                        addButton.disabled = false;
                    }
                }
            });
            
            // Trigger file selection dialog
            fileInput.click();
        }
        
        function openShareModal() {
            // Placeholder for modal functionality
            console.log('Opening share modal');
        }
        
        // Function to show ticket details in a modal
        function showTicketDetails(ticket) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s ease-out;
            `;
            
            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #1E1E2E;
                border-radius: 12px;
                padding: 32px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                animation: slideUp 0.3s ease-out;
            `;
            
            // Determine priority color
            const priorityColor = ticket.priority === 'High' ? '#FF6B6B' : 
                                ticket.priority === 'Medium' ? '#FFB366' : 
                                '#4ECDC4';
            
            modal.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
                    <h2 style="color: #FFFFFF; font-size: 24px; margin: 0;">${escapeHtml(ticket.title || 'Untitled')}</h2>
                    <button data-close-parent-modal style="
                        background: transparent;
                        border: none;
                        color: #8B8B9F;
                        font-size: 24px;
                        cursor: pointer;
                        padding: 0;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">&times;</button>
                </div>
                
                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <span style="
                        background: ${priorityColor}20;
                        color: ${priorityColor};
                        padding: 4px 12px;
                        border-radius: 16px;
                        font-size: 12px;
                        font-weight: 600;
                        text-transform: uppercase;
                    ">${ticket.priority || 'Normal'}</span>
                    <span style="
                        background: #0066FF20;
                        color: #0066FF;
                        padding: 4px 12px;
                        border-radius: 16px;
                        font-size: 12px;
                        font-weight: 600;
                        text-transform: uppercase;
                    ">${ticket.status || 'Open'}</span>
                    ${ticket.metadata?.category ? `
                        <span style="
                            background: #00D4FF20;
                            color: #00D4FF;
                            padding: 4px 12px;
                            border-radius: 16px;
                            font-size: 12px;
                            font-weight: 600;
                            text-transform: uppercase;
                        ">${ticket.metadata.category}</span>
                    ` : ''}
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="color: #8B8B9F; font-size: 12px; text-transform: uppercase; margin-bottom: 12px;">Description</h3>
                    <p style="color: #FFFFFF; line-height: 1.6; white-space: pre-wrap;">${escapeHtml(ticket.description || 'No description available')}</p>
                </div>
                
                ${ticket.metadata ? `
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #8B8B9F; font-size: 12px; text-transform: uppercase; margin-bottom: 12px;">Additional Fields</h3>
                        <div style="
                            background: #121212;
                            padding: 16px;
                            border-radius: 8px;
                            font-size: 13px;
                        ">
                            ${Object.entries(ticket.metadata)
                                .filter(([key]) => !key.startsWith('_'))
                                .map(([key, value]) => `
                                    <div style="
                                        display: flex;
                                        margin-bottom: 8px;
                                        padding-bottom: 8px;
                                        border-bottom: 1px solid rgba(139, 139, 159, 0.1);
                                    ">
                                        <span style="
                                            color: #8B8B9F;
                                            min-width: 120px;
                                            text-transform: capitalize;
                                        ">${key}:</span>
                                        <span style="
                                            color: #FFFFFF;
                                            flex: 1;
                                            word-break: break-word;
                                        ">${escapeHtml(String(value))}</span>
                                    </div>
                                `).join('')}
                        </div>
                        ${ticket.metadata._import_metadata ? `
                            <details style="margin-top: 12px;">
                                <summary style="
                                    color: #8B8B9F;
                                    font-size: 11px;
                                    cursor: pointer;
                                    padding: 4px 0;
                                ">Import Details</summary>
                                <pre style="
                                    background: #0A0A0F;
                                    padding: 8px;
                                    border-radius: 4px;
                                    color: #00D4FF;
                                    font-size: 10px;
                                    overflow-x: auto;
                                    margin-top: 8px;
                                ">${JSON.stringify(ticket.metadata._import_metadata, null, 2)}</pre>
                            </details>
                        ` : ''}
                    </div>
                ` : ''}
                
                <div style="display: flex; gap: 8px; font-size: 11px; color: #8B8B9F;">
                    <span>ID: ${ticket.id}</span>
                    ${ticket.external_id ? `<span>â€¢ External ID: ${ticket.external_id}</span>` : ''}
                    <span>â€¢ Created: ${new Date(ticket.created_at).toLocaleString()}</span>
                </div>
            `;
            
            modalOverlay.appendChild(modal);
            document.body.appendChild(modalOverlay);
            
            // Add animation styles if not present
            if (!document.querySelector('#modal-animations')) {
                const style = document.createElement('style');
                style.id = 'modal-animations';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Close on overlay click
            modalOverlay.onclick = (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            };
            
            // Close on escape key
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    modalOverlay.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        // Document viewer function for knowledge base articles
        async function viewDocument(documentId) {
            try {
                // Fetch document content from API
                const response = await fetch(`/api/rag/document/${documentId}/view`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load document');
                }
                
                const data = await response.json();
                const doc = data.document;
                
                // Create modal overlay
                const modalOverlay = document.createElement('div');
                modalOverlay.id = 'documentViewerModal';
                modalOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    animation: fadeIn 0.2s ease-out;
                `;
                
                // Create modal content
                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    max-width: 900px;
                    width: 90%;
                    max-height: 80vh;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    animation: slideUp 0.2s ease-out;
                `;
                
                // Format the date
                const createdDate = new Date(doc.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Determine status color
                const statusColors = {
                    ready: '#28a745',
                    processing: '#ffc107',
                    failed: '#dc3545',
                    vectorized: '#17a2b8'
                };
                const statusColor = statusColors[doc.status] || '#6c757d';
                
                // Create modal HTML
                modal.innerHTML = `
                    <div style="padding: 24px; border-bottom: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h2 id="documentTitle" style="margin: 0; color: #333; font-size: 24px;">
                                    ${doc.original_filename || 'Document'}
                                </h2>
                                <div id="documentMeta" style="margin-top: 8px; color: #666; font-size: 14px;">
                                    <span style="
                                        background: ${statusColor}; 
                                        color: white; 
                                        padding: 2px 8px; 
                                        border-radius: 4px;
                                        font-size: 12px;
                                        margin-right: 10px;
                                    ">${doc.status.toUpperCase()}</span>
                                    ${doc.is_processed ? '<span style="color: #28a745;">âœ“ Processed</span> â€¢ ' : ''}
                                    ${doc.file_type ? `<span>${doc.file_type}</span> â€¢ ` : ''}
                                    <span>${createdDate}</span>
                                </div>
                            </div>
                            <button data-close-doc-viewer style="
                                background: transparent;
                                border: none;
                                font-size: 24px;
                                cursor: pointer;
                                color: #666;
                                padding: 0;
                                width: 32px;
                                height: 32px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border-radius: 4px;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                Ã—
                            </button>
                        </div>
                    </div>
                    <div id="documentContent" style="
                        padding: 24px;
                        overflow-y: auto;
                        flex: 1;
                        font-size: 15px;
                        line-height: 1.6;
                        color: #333;
                    ">
                        ${formatDocumentContent(doc.display_content)}
                    </div>
                `;
                
                modalOverlay.appendChild(modal);
                document.body.appendChild(modalOverlay);
                
                // Close on background click
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        modalOverlay.remove();
                    }
                });
                
                // Close on ESC key
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        modalOverlay.remove();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
                
            } catch (error) {
                console.error('Error viewing document:', error);
                alert('Failed to load document. Please try again.');
            }
        }
        
        // Helper function to format document content
        function formatDocumentContent(content) {
            if (!content) return '<p style="color: #999;">No content available</p>';
            
            // Basic markdown-style formatting
            let formatted = content
                // Headers
                .replace(/^### (.*?)$/gm, '<h3 style="margin: 16px 0 8px 0; color: #333;">$1</h3>')
                .replace(/^## (.*?)$/gm, '<h2 style="margin: 20px 0 10px 0; color: #333;">$1</h2>')
                .replace(/^# (.*?)$/gm, '<h1 style="margin: 24px 0 12px 0; color: #333;">$1</h1>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Lists
                .replace(/^- (.*?)$/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.*?)$/gm, '<li>$2</li>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre style="background: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto;"><code>$1</code></pre>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code style="background: #f5f5f5; padding: 2px 4px; border-radius: 2px;">$1</code>')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraph tags if not already formatted
            if (!formatted.includes('<p>') && !formatted.includes('<h')) {
                formatted = `<p>${formatted}</p>`;
            }
            
            // Wrap consecutive <li> tags in <ul>
            formatted = formatted.replace(/(<li>.*?<\/li>\s*)+/g, (match) => {
                return `<ul style="margin: 8px 0; padding-left: 24px;">${match}</ul>`;
            });
            
            return formatted;
        }
    </script>
    
    <!-- QuikChat Scripts -->
    <script src="/components/action-button.js"></script>
    <script src="/quikchat.js"></script>
    <script src="/components/article-item.js"></script>
    <script src="/components/quikchat-rag.js"></script>
    <script src="/components/chat-enhancements.js"></script>
    <script src="/components/mobile-menu.js"></script>
    <script src="/components/chat-history.js"></script>
    <script>
        // Add event listeners to replace inline onclick handlers
        document.addEventListener('DOMContentLoaded', () => {
            // User avatar dropdown toggle
            const userAvatar = document.getElementById('user-avatar-toggle');
            if (userAvatar) {
                userAvatar.addEventListener('click', toggleUserDropdown);
            }

            // Copy tenant ID link
            const copyTenantLink = document.getElementById('copy-tenant-link');
            if (copyTenantLink) {
                copyTenantLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    copyTenantId();
                });
            }

            // Logout link
            const logoutLink = document.getElementById('logout-link');
            if (logoutLink) {
                logoutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    logout();
                });
            }

            // Share all button
            const shareAllBtn = document.getElementById('share-all-btn');
            if (shareAllBtn) {
                shareAllBtn.addEventListener('click', openShareModal);
            }

            // Knowledge upload area
            const knowledgeUpload = document.getElementById('knowledge-upload-area');
            if (knowledgeUpload) {
                knowledgeUpload.addEventListener('click', handleUpload);
            }

            // Knowledge management button
            const knowledgeManageBtn = document.getElementById('knowledge-manage-btn');
            if (knowledgeManageBtn) {
                knowledgeManageBtn.addEventListener('click', openKnowledgeManagement);
            }

            // Generic modal close buttons
            document.addEventListener('click', (e) => {
                // Close modal overlay buttons
                if (e.target.classList.contains('modal-close-generic')) {
                    const modalOverlay = e.target.closest('.modal-overlay');
                    if (modalOverlay) {
                        modalOverlay.remove();
                    }
                }

                // Close error modal button
                if (e.target.hasAttribute('data-close-error-modal')) {
                    const errorModal = document.getElementById('error-modal');
                    if (errorModal) {
                        errorModal.remove();
                    }
                }

                // Close parent modal button
                if (e.target.hasAttribute('data-close-parent-modal')) {
                    const parentModal = e.target.closest('div').parentElement.parentElement;
                    if (parentModal) {
                        parentModal.remove();
                    }
                }

                // Close document viewer modal
                if (e.target.hasAttribute('data-close-doc-viewer')) {
                    const docViewerModal = e.target.closest('#documentViewerModal');
                    if (docViewerModal) {
                        docViewerModal.remove();
                    }
                }
            });
        });

        // Initialize QuikChat when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize QuikChat RAG integration
            const chatRAG = new QuikChatRAG('#quikchat-container');
            chatRAG.init();
            
            // Store instance globally for debugging
            window.chatInstance = chatRAG;
            
            // Initialize modern chat enhancements
            setTimeout(() => {
                if (!window.chatEnhancements) {
                    window.chatEnhancements = new ChatEnhancements();
                    window.chatEnhancements.init();
                }
            }, 500); // Small delay to ensure QuikChat is fully rendered
            
            // Initialize chat history manager
            setTimeout(() => {
                if (!window.chatHistoryManager) {
                    window.chatHistoryManager = new ChatHistoryManager();
                    window.chatHistoryManager.init();
                }
            }, 1000); // Delay to ensure QuikChat is ready
            
            // Comment out Jarvis initialization for now
            // injectEspressiveWidget({ ... });
        });
    </script>
</body>
</html>