"use client";

import { ArrowLeft, ChevronRight } from "lucide-react";
import type { ReactNode } from "react";
import { useState } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import {
	Sidebar,
	SidebarContent,
	SidebarGroup,
	SidebarGroupLabel,
	SidebarHeader,
	SidebarMenu,
	SidebarMenuButton,
	SidebarMenuItem,
	SidebarMenuSub,
	SidebarMenuSubButton,
	SidebarMenuSubItem,
	SidebarProvider,
} from "@/components/ui/sidebar";
import { useProfilePermissions } from "@/hooks/api/useProfile";
import { cn } from "@/lib/utils";

interface RitaSettingsLayoutProps {
	children?: ReactNode;
}

export default function RitaSettingsLayout({
	children,
}: RitaSettingsLayoutProps) {
	const navigate = useNavigate();
	const location = useLocation();
	const { isOwnerOrAdmin } = useProfilePermissions();
	const [connectionSourcesOpen, setConnectionSourcesOpen] = useState(true);

	const handleBackToApp = () => {
		// Navigate to root, which will redirect to the default app route
		navigate("/");
	};

	// Check if current path matches route (including sub-routes)
	const isKnowledgeSourcesActive = location.pathname.startsWith("/settings/connections");
	const isItsmSourcesActive = location.pathname.startsWith("/settings/itsm");
	const isConnectionSourcesActive = isKnowledgeSourcesActive || isItsmSourcesActive;
	const isUsersActive = location.pathname.startsWith("/settings/users");
	const isProfileActive = location.pathname === "/settings/profile";

	return (
		<SidebarProvider defaultOpen={true}>
			<Sidebar>
				<SidebarHeader className="p-2">
					<SidebarMenu>
						<SidebarMenuItem>
							<SidebarMenuButton
								className="flex items-center gap-2 p-2 h-8 rounded-md cursor-pointer"
								onClick={handleBackToApp}
							>
								<ArrowLeft className="h-4 w-4" />
								<span className="text-sm">Settings</span>
							</SidebarMenuButton>
						</SidebarMenuItem>
					</SidebarMenu>
				</SidebarHeader>

				<SidebarContent>
					<SidebarGroup className="p-2">
						<SidebarMenu>
							<SidebarMenuItem>
								<SidebarMenuButton
									className={cn(
										"p-2 h-8 rounded-md cursor-pointer",
										isProfileActive && "bg-accent text-accent-foreground",
									)}
									onClick={() => navigate("/settings/profile")}
								>
									<span className="text-sm">Profile</span>
								</SidebarMenuButton>
							</SidebarMenuItem>
						</SidebarMenu>
					</SidebarGroup>

					{isOwnerOrAdmin() && (
					 
						 
							<SidebarGroup className="p-2">
								<SidebarGroupLabel className="px-2 h-8 text-xs opacity-70">
									Admin
								</SidebarGroupLabel>

								<SidebarMenu>
									{/* Connection Sources (Collapsible) */}
									<SidebarMenuItem>
										<SidebarMenuButton
											className="p-2 h-8 rounded-md cursor-pointer flex items-center gap-2"
											onClick={() => setConnectionSourcesOpen(!connectionSourcesOpen)}
										>
											<ChevronRight
												className={cn(
													"h-4 w-4 transition-transform",
													connectionSourcesOpen && "rotate-90",
												)}
											/>
											<span className="text-sm">Connection Sources</span>
										</SidebarMenuButton>

										{connectionSourcesOpen && (
											<SidebarMenuSub>
												<SidebarMenuSubItem>
													<SidebarMenuSubButton
														className={cn(
															"px-2 h-7 rounded-md cursor-pointer",
															isKnowledgeSourcesActive &&
																"bg-accent text-accent-foreground",
														)}
														onClick={() => navigate("/settings/connections")}
													>
														<span className="text-sm">Knowledge Sources</span>
													</SidebarMenuSubButton>
												</SidebarMenuSubItem>
												<SidebarMenuSubItem>
													<SidebarMenuSubButton
														className={cn(
															"px-2 h-7 rounded-md cursor-pointer",
															isItsmSourcesActive &&
																"bg-accent text-accent-foreground",
														)}
														onClick={() => navigate("/settings/itsm")}
													>
														<span className="text-sm">ITSM Sources</span>
													</SidebarMenuSubButton>
												</SidebarMenuSubItem>
											</SidebarMenuSub>
										)}
									</SidebarMenuItem>
									<SidebarMenuItem>
										<SidebarMenuButton
											className={cn(
												"p-2 h-8 rounded-md cursor-pointer",
												isUsersActive && "bg-accent text-accent-foreground",
											)}
											onClick={() => navigate("/settings/users")}
										>
											<span className="text-sm">Users</span>
										</SidebarMenuButton>
									</SidebarMenuItem>
								</SidebarMenu>
							</SidebarGroup>
					 
					)}
				</SidebarContent>
				<div className="p-2 border-t border-sidebar-border invisible w-[256px]" />
			</Sidebar>
		 
			<main className="w-full md:ml-[calc(var(--sidebar-width)+2em)]">
				 {children}
			</main>
 
		</SidebarProvider>
	);
}